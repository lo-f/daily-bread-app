{% extends 'base.html' %}
{% load static %}

{% block head %}
<!-- Additional styles or scripts if needed -->
{% endblock %}

{% block content %}

<h1>Update Feeding</h1>

<div class="container mt-5">
    <h2>Edit Meal</h2>
    <form method="post" id="feeding-form">
        {% csrf_token %}

        <div>
            <h3>Update Feeding</h3>
            {{ feeding_form.as_p }}

            <h4>Food Items</h4>
            <div id="food-items">
                {{ food_item_formset.management_form }}
                {% for form in food_item_formset %}
                <div class="food-item-form">
                    {{ form.as_p }}
                    <button type="button" class="remove-form">Remove</button>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-food-item">Add Food Item</button>
            <button type="submit">Save Changes</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formsetDiv = document.getElementById('food-items');
        const addFoodItemBtn = document.getElementById('add-food-item');
        const totalForms = document.querySelector('[name="fooditem-TOTAL_FORMS"]');

        addFoodItemBtn.addEventListener('click', function () {
            const currentFormCount = formsetDiv.getElementsByClassName('food-item-form').length;
            const newForm = formsetDiv.getElementsByClassName('food-item-form')[0].cloneNode(true);

            updateFormIndex(newForm, currentFormCount);

            const newFormInputs = newForm.querySelectorAll('input, select, textarea');
            newFormInputs.forEach(input => {
                if (input.type !== 'hidden') {
                    input.value = '';
                }
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                }
            });

            formsetDiv.appendChild(newForm);

            totalForms.setAttribute('value', currentFormCount + 1);

            addRemoveHandlers();
        });

        function updateFormIndex(form, index) {
            const regex = /fooditem-(\d+)-/g;
            form.innerHTML = form.innerHTML.replace(regex, `fooditem-${index}-`);

            const allElements = form.querySelectorAll('input, label');
            allElements.forEach(element => {
                if (element.id) {
                    element.id = element.id.replace(regex, `fooditem-${index}-`);
                }
                if (element.name) {
                    element.name = element.name.replace(regex, `fooditem-${index}-`);
                }
                if (element.htmlFor) {
                    element.htmlFor = element.htmlFor.replace(regex, `fooditem-${index}-`);
                }
            });
        }

        function addRemoveHandlers() {
            const removeButtons = document.querySelectorAll('.remove-form');
            removeButtons.forEach(button => {
                button.onclick = function (e) {
                    e.preventDefault();
                    const formToRemove = e.target.closest('.food-item-form');
                    formToRemove.remove();

                    updateTotalForms();
                };
            });
        }

        function updateTotalForms() {
            const formCount = formsetDiv.getElementsByClassName('food-item-form').length;
            totalForms.setAttribute('value', formCount);
        }

        addRemoveHandlers();
    });

</script>

{% endblock %}