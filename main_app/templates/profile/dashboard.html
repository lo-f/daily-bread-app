{% extends 'base.html' %}
{% load static %}
{% block head %}

{% endblock %}

{% block content %}

<h1>Dashboard</h1>

<h2>Feedings</h2>
<ul>
    {% for feeding in feedings %}
    <li>
        <a href="{% url 'meal-detail' feeding.id %}">{{ feeding }}</a>
    </li>
    {% endfor %}
</ul>

<div class="container mt-5">
    <h2>Create a New Meal</h2>


    <form method="post" id="feeding-form">
        {% csrf_token %}

        <div>
            <h3>Create a Feeding</h3>
            {{ feeding_form.as_p }}

            <h4>Food Items</h4>
            <div>
                <input type="text" id="nutrition-search" placeholder="Search food">
                <button type="button" id="search-button">Search</button>
            </div>
            <div id="food-items">
                {{ food_item_formset.management_form }}
                {% for form in food_item_formset %}
                <div class="food-item-form">
                    {{ form.as_p }}
                    <button type="button" class="remove-form">Remove</button>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-food-item">Add Food Item</button>
            <button type="submit">Save Feeding</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const formsetDiv = document.getElementById('food-items');
        const addFoodItemBtn = document.getElementById('add-food-item');
        const totalForms = document.querySelector('[name="fooditem-TOTAL_FORMS"]');
        const searchButton = document.getElementById('search-button');
        const searchInput = document.getElementById('nutrition-search');
        const searchResultsDiv = document.getElementById('search-results');

        // Search Button Click Event
        searchButton.addEventListener('click', function () {
            const query = searchInput.value;
            if (!query) {
                alert('Please enter a search query');
                return;
            }

            fetch(`/get-nutrition-data?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                    } else {
                        populateFoodItemForm(data);
                    }
                })
                .catch(error => console.error('Error fetching nutrition data:', error));
        });

        // Add Food Item from Search
        function populateFoodItemForm(data) {
            const currentFormCount = formsetDiv.getElementsByClassName('food-item-form').length;
            const newForm = formsetDiv.getElementsByClassName('food-item-form')[0].cloneNode(true);

            updateFormIndex(newForm, currentFormCount);

            newForm.querySelector('[name$="name"]').value = data.foods[0].food_name;
            newForm.querySelector('[name$="calories"]').value = data.foods[0].nf_calories;
            newForm.querySelector('[name$="fats"]').value = data.foods[0].nf_total_fat;
            newForm.querySelector('[name$="proteins"]').value = data.foods[0].nf_protein;
            newForm.querySelector('[name$="carbs"]').value = data.foods[0].nf_total_carbohydrate;

            formsetDiv.appendChild(newForm);
            totalForms.setAttribute('value', currentFormCount + 1);
            addRemoveHandlers();
        }

        // ADD/REMOVE FORMS
        addFoodItemBtn.addEventListener('click', function () {
            const currentFormCount = formsetDiv.getElementsByClassName('food-item-form').length;
            const newForm = formsetDiv.getElementsByClassName('food-item-form')[0].cloneNode(true);

            updateFormIndex(newForm, currentFormCount);

            const newFormInputs = newForm.getElementsByTagName('input');
            for (let input of newFormInputs) {
                input.value = '';
            }

            formsetDiv.appendChild(newForm);

            totalForms.setAttribute('value', currentFormCount + 1);

            addRemoveHandlers();
        });

        function updateFormIndex(form, index) {
            const regex = /fooditem-(\d+)-/g;
            form.innerHTML = form.innerHTML.replace(regex, `fooditem-${index}-`);

            const allElements = form.querySelectorAll('input, label');
            allElements.forEach(element => {
                if (element.id) {
                    element.id = element.id.replace(regex, `fooditem-${index}-`);
                }
                if (element.name) {
                    element.name = element.name.replace(regex, `fooditem-${index}-`);
                }
                if (element.htmlFor) {
                    element.htmlFor = element.htmlFor.replace(regex, `fooditem-${index}-`);
                }
            });
        }

        function addRemoveHandlers() {
            const removeButtons = document.querySelectorAll('.remove-form');
            removeButtons.forEach(button => {
                button.onclick = function (e) {
                    e.preventDefault();
                    const formToRemove = e.target.closest('.food-item-form');
                    formToRemove.remove();

                    updateTotalForms();
                };
            });
        }

        function updateTotalForms() {
            const formCount = formsetDiv.getElementsByClassName('food-item-form').length;
            totalForms.setAttribute('value', formCount);
        }

        addRemoveHandlers();
    });

</script>

{% endblock %}